name: SPFx Site-Level CI/CD (Node18 build + Node20 deploy)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 游릭 Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 游릭 Step 2: Setup Node.js 18 for SPFx build
      - name: Setup Node.js 18 (for SPFx build)
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # 游릭 Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # 游릭 Step 4: Build & package SPFx
      - name: Build and package SPFx
        run: |
          gulp clean
          gulp bundle --ship
          gulp package-solution --ship

      # 游릭 Step 5: Save sppkg as artifact (to pass to next Node version)
      - name: Upload sppkg artifact
        uses: actions/upload-artifact@v4
        with:
          name: spfx-package
          path: sharepoint/solution/*.sppkg

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-deploy

    steps:
      # 游릭 Step 1: Download the sppkg artifact
      - name: Download sppkg artifact
        uses: actions/download-artifact@v4
        with:
          name: spfx-package
          path: ./deploy

      # 游릭 Step 2: Setup Node.js 20 (for Microsoft 365 CLI)
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 游릭 Step 3: Install CLI for Microsoft 365
      - name: Install CLI for Microsoft 365
        run: npm install -g @pnp/cli-microsoft365

      # 游릭 Step 4: Authenticate with Azure AD App (Client Secret Auth)
      - name: Login with Azure AD App (Client Secret Auth)
        run: |
          m365 login --authType secret \
            --tenant ${{ secrets.SPO_TENANT_ID }} \
            --appId ${{ secrets.SPO_CLIENT_ID }} \
            --secret ${{ secrets.SPO_CLIENT_SECRET }}

      # 游릭 Step 5: Upload SPFx app to Site App Catalog
      - name: Upload SPFx to Site App Catalog
        run: |
          m365 spo app add \
            --filePath ./deploy/*.sppkg \
            --appCatalogScope sitecollection \
            --appCatalogUrl ${{ secrets.SPO_SITE_URL }} \
            --overwrite

      # 游릭 Step 6: Deploy SPFx app on Site
      - name: Deploy SPFx app
        run: |
          APP_NAME=$(basename ./deploy/*.sppkg)
          echo "Deploying $APP_NAME to site collection app catalog..."
          m365 spo app deploy \
            --name "$APP_NAME" \
            --appCatalogScope sitecollection \
            --appCatalogUrl ${{ secrets.SPO_SITE_URL }}

